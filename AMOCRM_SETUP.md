# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AmoCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ AmoCRM

1. –ó–∞–π–¥–∏—Ç–µ –≤ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç AmoCRM
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** ‚Üí **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º**
3. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é"**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: "–Ø–Ω—Ç–∞—Ä–Ω—ã–π –ò–ò –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç"
   - –û–ø–∏—Å–∞–Ω–∏–µ: "Telegram –±–æ—Ç –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤"
   - Redirect URI: `https://amberry.ru/callback`

## –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∞:
- **–ö–æ–Ω—Ç–∞–∫—Ç—ã**: —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä
- **–°–¥–µ–ª–∫–∏**: —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä  
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏—è**: —Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä
- **–ó–∞–¥–∞—á–∏**: —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –ø—Ä–æ—Å–º–æ—Ç—Ä (–¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–¥–∞—á)

## –®–∞–≥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ:
- **Client ID**
- **Client Secret**

## –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞

–û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à `.env` —Ñ–∞–π–ª:

```env
# AmoCRM API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
AMOCRM_SUBDOMAIN=–≤–∞—à_–ø–æ–¥–¥–æ–º–µ–Ω  # –Ω–∞–ø—Ä–∏–º–µ—Ä: amber-jewelry
AMOCRM_CLIENT_ID=
AMOCRM_CLIENT_SECRET=–≤–∞—à_client_secret
AMOCRM_REDIRECT_URI=https://amberry.ru/callback
AMOCRM_BASE_URL=https://–≤–∞—à_–ø–æ–¥–¥–æ–º–µ–Ω.amocrm.ru
```

## –®–∞–≥ 5: –ü–µ—Ä–≤–∏—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
```
https://–≤–∞—à_–ø–æ–¥–¥–æ–º–µ–Ω.amocrm.ru/oauth2/authorize?client_id=–í–ê–®–ò_CLIENT_ID&response_type=code&redirect_uri=https://amberry.ru/callback&scope=crm
```

2. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É AmoCRM

3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ URL –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:
```
https://amberry.ru/callback?code=–ü–û–õ–£–ß–ï–ù–ù–´–ô_–ö–û–î&referer=...
```

4. –°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã:

```python
import requests
import json

# –î–∞–Ω–Ω—ã–µ –∏–∑ .env
client_id = "–≤–∞—à_client_id"
client_secret = "–≤–∞—à_client_secret"
redirect_uri = "https://amberry.ru/callback"
authorization_code = "–ö–û–î_–ò–ó_–ü–†–ï–î–´–î–£–©–ï–ì–û_–®–ê–ì–ê"
subdomain = "–≤–∞—à_–ø–æ–¥–¥–æ–º–µ–Ω"

# –û–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Ç–æ–∫–µ–Ω—ã
url = f"https://{subdomain}.amocrm.ru/oauth2/access_token"
data = {
    "client_id": client_id,
    "client_secret": client_secret,
    "grant_type": "authorization_code",
    "code": authorization_code,
    "redirect_uri": redirect_uri
}

response = requests.post(url, json=data)
tokens = response.json()

print("Access Token:", tokens.get("access_token"))
print("Refresh Token:", tokens.get("refresh_token"))
print("Expires In:", tokens.get("expires_in"))
```

## –®–∞–≥ 6: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Å–∏—Å—Ç–µ–º—É

1. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ `.env`:
```env
AMOCRM_ACCESS_TOKEN=–ø–æ–ª—É—á–µ–Ω–Ω—ã–π_access_token
AMOCRM_REFRESH_TOKEN=–ø–æ–ª—É—á–µ–Ω–Ω—ã–π_refresh_token
```

2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ TokenManager –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
```python
from src.integrations.token_manager import TokenManager

token_manager = TokenManager()
token_manager.save_amocrm_tokens(
    access_token="–ø–æ–ª—É—á–µ–Ω–Ω—ã–π_access_token",
    refresh_token="–ø–æ–ª—É—á–µ–Ω–Ω—ã–π_refresh_token",
    expires_in=86400  # –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
)
```

## –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª–µ–π AmoCRM

–í –∫–æ–¥–µ AmoCRM –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å ID –ø–æ–ª–µ–π –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ:

```python
# –í –º–µ—Ç–æ–¥–µ create_contact() –∑–∞–º–µ–Ω–∏—Ç–µ:
"field_id": 123456,  # TODO: ID –ø–æ–ª—è Telegram ID
"field_id": 123457,  # TODO: ID –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞

# –í –º–µ—Ç–æ–¥–µ create_lead() –∑–∞–º–µ–Ω–∏—Ç–µ:
"status_id": 123456,  # TODO: ID —Å—Ç–∞—Ç—É—Å–∞ "–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞"  
"field_id": 123458,  # TODO: ID –ø–æ–ª—è "–ò—Å—Ç–æ—á–Ω–∏–∫"
```

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ API –∑–∞–ø—Ä–æ—Å—ã:
- –ü–æ–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: `GET /api/v4/contacts/custom_fields`
- –ü–æ–ª—è —Å–¥–µ–ª–æ–∫: `GET /api/v4/leads/custom_fields`
- –°—Ç–∞—Ç—É—Å—ã —Å–¥–µ–ª–æ–∫: `GET /api/v4/leads/pipelines`

## –®–∞–≥ 8: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
```bash
python test_amocrm.py
```

–ï—Å–ª–∏ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤—ã —É–≤–∏–¥–∏—Ç–µ:
```
‚úÖ –£—Å–ø–µ—à–Ω–æ: 3/3
üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AmoCRM —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è. –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª `tokens.json` –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å `.env` —Ñ–∞–π–ª–æ–º.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è AmoCRM API](https://www.amocrm.ru/developers/)
- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ OAuth 2.0](https://www.amocrm.ru/developers/content/oauth/step-by-step)
- [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞](https://www.amocrm.ru/developers/content/oauth/scopes)