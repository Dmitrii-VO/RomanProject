# Project Knowledge Map - ИИ Консультант Янтарного Магазина

## 🎯 Цель проекта

**ИИ-консультант интернет-магазина ювелирных украшений из янтаря**

Создание интеллектуального помощника для автоматизации процесса консультирования клиентов интернет-магазина янтарных украшений с возможностью эскалации к живому сотруднику в сложных ситуациях.

## 👨‍💼 Роль ИИ-консультанта

**Опытный продавец янтаря** со следующими функциями:

- **Подбор украшений** - помощь в выборе подходящих изделий из ассортимента
- **Учет бюджета** - рекомендации в рамках финансовых возможностей клиента  
- **Экспертные знания** - рассказы о свойствах янтаря, его происхождении и особенностях
- **Оформление заказов** - полное сопровождение процесса покупки
- **Эскалация** - передача сложных случаев живому консультанту

## 🔗 API и интеграции

### Основные сервисы:
- **OpenAI API** - ИИ-движок для обработки естественного языка
- **AmoCRM** - управление клиентскими отношениями и сделками
- **МойСклад** - управление товарами, остатками и заказами
- **Почта России API** - расчет стоимости и сроков доставки
- **ЮKassa** - обработка платежей

### Коммуникационные каналы:
- **Telegram Bot API** - основной канал общения с клиентами
- **Telegram User API** - расширенные возможности для userbot

## 🏗 Архитектура системы

```
                    ┌─────────────────┐
                    │     КЛИЕНТ      │
                    └─────────┬───────┘
                              │
                              ▼
                 ┌─────────────────────────┐
                 │  TELEGRAM USERBOT       │
                 │  (Telethon)             │
                 └─────────┬───────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │   ИИ КОНСУЛЬТАНТ        │
                 │   (OpenAI API)          │
                 └─────────┬───────────────┘
                           │
          ┌────────────────┼────────────────┐
          ▼                ▼                ▼
    ┌───────────┐  ┌──────────────┐  ┌─────────────┐
    │ AmoCRM    │  │ МойСклад     │  │ Почта России│
    │ (CRM)     │  │ (Склад)      │  │ (Доставка)  │
    └───────────┘  └──────────────┘  └─────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           ▼
                 ┌─────────────────────────┐
                 │   ПЛАТЕЖНАЯ СИСТЕМА     │
                 │   (ЮKassa)             │
                 └─────────────────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │ ЛОГИРОВАНИЕ & ЗНАНИЯ    │
                 │ (База данных)           │
                 └─────────────────────────┘
                           │
                           ▼
                 ┌─────────────────────────┐
                 │   ЭСКАЛАЦИЯ К           │
                 │   СОТРУДНИКУ            │
                 └─────────────────────────┘
```

## 📊 Детальная архитектура модулей

### 1. 🤖 Telegram Userbot (Telethon)
- **Функции**: Обработка входящих сообщений, отправка ответов
- **Особенности**: Работа от имени пользователя, продвинутые возможности Telegram
- **API**: Telethon библиотека для Python
- **Взаимодействие**: Первичный интерфейс с клиентами

### 2. 🧠 OpenAI API (ИИ-ответы)
- **Функции**: Генерация естественных ответов, анализ запросов клиентов
- **Модель**: GPT с настроенными параметрами для продаж янтаря
- **Параметры**: temperature=0.7, max_tokens=500, penalties для качества
- **Контекст**: База знаний о янтаре, каталог товаров

### 3. 📈 AmoCRM API (Сделки и менеджеры)
- **Функции**: Создание сделок, управление клиентами, назначение менеджеров
- **Данные**: Контакты, история покупок, предпочтения клиентов
- **Интеграция**: Автоматическое создание лидов из Telegram диалогов
- **Эскалация**: Уведомления менеджеров о сложных случаях

### 4. 📦 МойСклад API (Каталог и заказы)
- **Функции**: Получение актуального каталога, проверка остатков, создание заказов
- **Данные**: Товары, цены, характеристики янтарных изделий, остатки
- **Синхронизация**: Реальное время для актуальности данных
- **Заказы**: Автоматическое оформление после подтверждения клиента

### 5. 📮 Почта России API (Расчет доставки)
- **Функции**: Расчет стоимости и сроков доставки по регионам
- **Данные**: Тарифы, сроки, отслеживание посылок
- **Интеграция**: Автоматический расчет при оформлении заказа
- **Опции**: Различные виды доставки (обычная, EMS, курьер)

### 6. 💳 ЮKassa API (Оплата)
- **Функции**: Обработка платежей, генерация ссылок для оплаты
- **Методы**: Карты, электронные кошельки, банковские переводы
- **Безопасность**: PCI DSS сертификация, токенизация
- **Уведомления**: Webhook для обновления статуса заказов

### 7. 📝 Логирование и база знаний
- **Функции**: Сохранение всех диалогов, анализ эффективности
- **Структура**: JSON логи с метаданными диалогов
- **База знаний**: 
  - Характеристики янтаря
  - FAQ по украшениям
  - Инструкции по уходу
  - Сценарии продаж
- **Аналитика**: Успешность диалогов, популярные запросы

## 🔄 Поток взаимодействия модулей

### Сценарий консультации:
1. **Клиент** → пишет в Telegram userbot
2. **Telethon** → получает сообщение, передает в ИИ
3. **OpenAI** → анализирует запрос, обращается к базе знаний
4. **МойСклад** → предоставляет информацию о товарах
5. **ИИ** → формирует персонализированный ответ
6. **AmoCRM** → сохраняет информацию о клиенте
7. **Логирование** → записывает диалог

### Сценарий заказа:
1. **Клиент** → выбирает товар
2. **МойСклад** → резервирует товар
3. **Почта России** → рассчитывает доставку
4. **ЮKassa** → генерирует ссылку для оплаты
5. **AmoCRM** → создает сделку
6. **Уведомления** → информируют менеджера

### Сценарий эскалации:
1. **ИИ** → определяет сложный случай
2. **AmoCRM** → назначает менеджера
3. **Telegram** → уведомляет о передаче менеджеру
4. **Логирование** → фиксирует причину эскалации

## 📋 Ключевые функции системы

- Консультирование по янтарным украшениям
- Подбор товаров по критериям (цена, стиль, размер)
- Управление заказами от консультации до оплаты
- Интеграция с системами учета и CRM
- Автоматический расчет доставки
- Логирование всех диалогов
- Эскалация к сотруднику при необходимости

## 🔧 Техническое окружение (реализовано)

### Структура проекта:
```
amber_ai_consultant/
├── .env                    # Переменные окружения с API ключами
├── .gitignore             # Исключения для Git
├── requirements.txt       # Зависимости Python
├── test_hello.py          # Тестовый скрипт проверки окружения
├── venv/                  # Виртуальное окружение Python
├── logs/                  # Файлы логирования
│   ├── bot.log           # Основные логи приложения
│   ├── conversations.log # Диалоги с клиентами
│   └── errors.log        # Только ошибки
├── utils/                 # Утилиты и вспомогательные модули
│   ├── __init__.py
│   └── logger.py         # Настройка системы логирования
├── knowledge_map/         # Карты знаний проекта
│   └── project_knowledge.md
└── CLAUDE.md             # Руководство для Claude Code
```

### Установленные зависимости:
- **telethon** 1.41.0 - Telegram User API
- **fastapi** 0.116.1 - Web API framework
- **openai** 1.104.0 - OpenAI API клиент
- **requests** - HTTP клиент для API запросов
- **uvicorn** - ASGI сервер
- **python-dotenv** - Загрузка переменных окружения
- **loguru** - Продвинутое логирование
- **pytest** - Тестирование

### Настроенные переменные окружения:
- **OpenAI**: API ключ и базовый URL
- **Telegram**: Bot token, API ID/Hash для userbot
- **МойСклад**: Токен, логин, пароль, базовый URL
- **AmoCRM**: Client ID/Secret, redirect URI, auth code
- **ЮKassa**: Shop ID, secret key
- **Почта России**: Логин, пароль, токен (заглушки)
- **Настройки ИИ**: temperature=0.7, max_tokens=500, penalties
- **Приложение**: DEBUG=True, LOG_LEVEL=INFO

### Система логирования:
- **Многоуровневое логирование** с ротацией файлов
- **Цветной вывод** в консоль при DEBUG=True
- **Раздельные логи**: основные, ошибки, диалоги
- **Автоматическое сжатие** старых логов
- **Функция log_conversation()** для диалогов с метаданными

### Команды запуска:
```bash
# Активация виртуального окружения
source venv/bin/activate

# Тестирование окружения
python test_hello.py

# Установка зависимостей (при необходимости)
pip install -r requirements.txt
```

## 📈 Статус разработки

✅ **Этап 1**: Цель и Knowledge Map - ЗАВЕРШЕН
✅ **Этап 2**: Архитектура системы - ЗАВЕРШЕН  
✅ **Этап 3**: Подготовка окружения - ЗАВЕРШЕН

🔄 **Следующие этапы**:
- Этап 4: Реализация базовых модулей
- Этап 5: Интеграция с внешними API
- Этап 6: Создание ИИ консультанта
- Этап 7: Тестирование и деплой